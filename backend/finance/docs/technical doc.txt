# Financial Management System - Technical Documentation

## üìã **SYSTEM OVERVIEW**

### **Architecture Pattern**
```
Django REST Framework + PostgreSQL + Redis (Caching)
‚îî‚îÄ‚îÄ Modular Design with Service Layer Pattern
```

### **Core Components**
```
finance/
‚îú‚îÄ‚îÄ models.py          # Database models
‚îú‚îÄ‚îÄ serializers.py     # API serialization
‚îú‚îÄ‚îÄ views.py           # API endpoints
‚îú‚îÄ‚îÄ permissions.py     # Access control
‚îú‚îÄ‚îÄ middleware.py      # Request processing
‚îú‚îÄ‚îÄ services/          # Business logic
‚îú‚îÄ‚îÄ utils/             # Utilities
‚îî‚îÄ‚îÄ urls.py           # URL routing
```

---

## üîê **AUTHENTICATION & AUTHORIZATION**

### **Admin Impersonation System**

#### **How to Use Impersonation:**
```http
# Super Admin impersonating user 123 in workspace 456
GET /api/workspaces/?user_id=123&workspace_id=456
Authorization: Bearer <super_admin_token>

# Workspace Admin impersonating user 123 (all common workspaces)
GET /api/transactions/?user_id=123
Authorization: Bearer <workspace_admin_token>
```

#### **Impersonation Flow:**
1. **Middleware** detects `user_id` parameter
2. **Validates** admin permissions and rate limits
3. **Sets** `request.target_user` and `request.is_admin_impersonation`
4. **Filters** data based on `impersonation_workspace_ids`

#### **Response Context:**
```json
{
  "data": [...],
  "admin_impersonation": {
    "target_user_id": 123,
    "target_username": "john_doe",
    "requested_by_admin_id": 1
  }
}
```

#### **Admin Types & Access:**
- **Super Admin**: Can impersonate ANY user and see ALL their workspaces
- **Workspace Admin**: Can impersonate users but only in SHARED workspaces (where admin has rights)

---

## üè¢ **WORKSPACE SYSTEM**

### **Workspace Roles & Permissions**
| Role | View Data | Edit Data | Manage Members | Delete Workspace |
|------|-----------|-----------|----------------|------------------|
| Viewer | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Editor | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Admin | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå (soft delete only) |
| Owner | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (hard delete) |

### **Workspace Lifecycle**
```python
# Create workspace (automatically becomes owner)
POST /api/workspaces/
{"name": "Sales Team", "description": "Sales department finances"}

# Soft delete (inactive - admin/owner only)
DELETE /api/workspaces/1/

# Hard delete (permanent - owner only) 
DELETE /api/workspaces/1/hard-delete/
{"confirmation": {"standard": true, "workspace_name": "Sales Team"}}

# Activate inactive workspace
POST /api/workspaces/1/activate/
```

### **Workspace Endpoints:**
- `GET /api/workspaces/` - List user's workspaces
- `GET /api/workspaces/1/members/` - List workspace members
- `GET /api/workspaces/1/membership-info/` - Get user's membership details
- `GET /api/workspaces/1/settings/` - Get workspace settings

---

## üí∞ **TRANSACTION MANAGEMENT**

### **Transaction Types & Categories**
```python
# Expense Transaction
{
  "type": "expense",
  "original_amount": "100.00",
  "original_currency": "USD",
  "expense_category": 1,  # Must be expense category
  "date": "2024-01-15",
  "tags": ["marketing", "q1-2024"]
}

# Income Transaction  
{
  "type": "income", 
  "original_amount": "5000.00",
  "original_currency": "EUR",
  "income_category": 5,  # Must be income category
  "date": "2024-01-20"
}
```

### **Transaction Validation Rules:**
- Must have exactly one category (expense OR income)
- Category type must match transaction type
- Amount must be positive
- Category must belong to the workspace

### **Bulk Operations**
```python
# Bulk sync (create, update, delete in one call)
POST /api/workspaces/1/transactions/bulk-sync/
{
  "create": [...],
  "update": [...],
  "delete": [101, 102, 103]
}

# Bulk delete
POST /api/transactions/bulk-delete/
{"ids": [1, 2, 3, 4, 5]}
```

### **Performance Optimizations:**
- **Lightweight mode**: `GET /api/transactions/?light=true` - minimal data for lists
- **Bulk operations**: Atomic create/update/delete in single transaction
- **Selective prefetching**: Optimized database queries

---

## üí± **CURRENCY SYSTEM**

### **Supported Currencies**
- `EUR` - Euro (base currency)
- `USD` - US Dollar
- `GBP` - British Pound
- `CHF` - Swiss Franc
- `PLN` - Polish Zloty
- `CZK` - Czech Koruna

### **Currency Conversion Logic**
```python
# Three conversion scenarios:
1. Same currency: amount_domestic = original_amount
2. EUR ‚Üí other: amount_domestic = original_amount / rate_domestic  
3. Other ‚Üí EUR: amount_domestic = original_amount * rate_original
4. Cross-currency: original ‚Üí EUR ‚Üí domestic
```

### **Atomic Currency Change**
```python
# Change workspace currency (atomic operation)
PATCH /api/workspace-settings/1/
{"domestic_currency": "USD"}

# This automatically:
# 1. Updates workspace currency
# 2. Recalculates ALL transaction domestic amounts
# 3. Rolls back completely if any conversion fails
```

### **Exchange Rate Management**
```python
# Get historical rates
GET /api/exchange-rates/?currencies=USD,GBP&date_from=2024-01-01&date_to=2024-01-31

# Rate lookup logic:
# - Finds closest available rate ON or BEFORE transaction date
# - Uses EUR as base currency for cross-conversions
# - Caches rates for performance
```

---

## üìÇ **CATEGORY MANAGEMENT**

### **Category Structure**
- **5 hierarchical levels** (Level 1 = Root, Level 5 = Leaf)
- **Separate trees** for expenses and incomes
- **Version control** with audit trail
- **Flexible validation** supports flat and tree structures

### **Category Synchronization**
```python
# Sync category tree
POST /api/workspaces/1/categories/expense/sync/
{
  "create": [
    {
      "temp_id": "cat_1",
      "name": "Marketing",
      "level": 2,
      "parent_temp_id": null
    },
    {
      "temp_id": "cat_2", 
      "name": "Online Ads",
      "level": 3,
      "parent_temp_id": "cat_1"
    }
  ],
  "update": [
    {
      "id": 5,
      "name": "Updated Name",
      "level": 2
    }
  ],
  "delete": [10, 11]
}
```

### **Validation Rules:**
- **Leaf categories** (level 5) cannot have children
- **Level progression** must be consistent (+1 only)
- **No circular references** in hierarchy
- **Category names** must be unique within version

---

## üìù **API ENDPOINTS REFERENCE**

### **Workspace Management**
- `GET/POST /api/workspaces/` - List/Create workspaces
- `GET/PUT/PATCH/DELETE /api/workspaces/{id}/` - CRUD operations
- `POST /api/workspaces/{id}/activate/` - Activate inactive workspace
- `DELETE /api/workspaces/{id}/hard-delete/` - Permanent deletion
- `GET /api/workspaces/{id}/members/` - List members
- `GET /api/workspaces/{id}/membership-info/` - User membership

### **Transaction Management**
- `GET/POST /api/transactions/` - List/Create transactions
- `GET/PUT/PATCH/DELETE /api/transactions/{id}/` - CRUD operations
- `POST /api/transactions/bulk-delete/` - Bulk deletion
- `POST /api/workspaces/{id}/transactions/bulk-sync/` - Atomic sync

### **Category Management**
- `GET /api/expense-categories/` - List expense categories
- `GET /api/income-categories/` - List income categories
- `POST /api/workspaces/{id}/categories/{type}/sync/` - Sync category tree

### **Settings & Configuration**
- `GET/PATCH /api/user-settings/{id}/` - User preferences
- `GET/PATCH /api/workspace-settings/{id}/` - Workspace configuration
- `GET /api/exchange-rates/` - Historical exchange rates

### **Draft Management**
- `GET/POST /api/transaction-drafts/` - List/Create drafts
- `GET/PUT/PATCH/DELETE /api/transaction-drafts/{id}/` - CRUD operations
- `POST /api/workspaces/{id}/transaction-drafts/save-draft/` - Save workspace draft
- `GET /api/workspaces/{id}/transaction-drafts/get-workspace-draft/` - Get workspace draft
- `DELETE /api/transaction-drafts/{id}/discard/` - Discard draft

---

## üîß **SERVICE LAYER ARCHITECTURE**

### **TransactionService**
- `bulk_create_transactions()` - Atomic bulk creation
- `bulk_sync_transactions()` - Universal create/update/delete
- `recalculate_all_transactions_for_workspace()` - Currency change handler

### **CurrencyService**
- `change_workspace_currency()` - Atomic currency change
- `validate_currency_change()` - Pre-validation

### **Utility Functions**
- `recalculate_transactions_domestic_amount()` - Currency conversion
- `sync_categories_tree()` - Category hierarchy synchronization
- `validate_category_hierarchy()` - Tree structure validation

---

## üõ°Ô∏è **SECURITY FEATURES**

### **Permission Classes**
- `IsWorkspaceMember` - Basic workspace access
- `IsWorkspaceEditor` - Write operations
- `IsWorkspaceAdmin` - Administrative actions
- `IsWorkspaceOwner` - Ownership-level operations

### **Security Measures**
- **Rate limiting** on impersonation (10 requests/minute)
- **Workspace existence validation** before any access
- **Cached permission checks** for performance
- **Atomic operations** for data consistency
- **Comprehensive audit logging** all actions

### **Data Isolation**
- **User context enforcement** via middleware
- **Workspace-scoped queries** in all viewsets
- **Admin impersonation boundaries** respect user permissions

---

## üìä **PERFORMANCE OPTIMIZATIONS**

### **Database Optimizations**
- **Selective prefetch_related** based on view context
- **Bulk operations** with batch processing
- **Database indexes** on all foreign keys and search fields
- **Annotated counts** to avoid N+1 queries

### **Caching Strategy**
- **Permission caching** (5 minutes) in middleware
- **Workspace membership caching** per request
- **Exchange rate caching** for conversion performance

### **API Optimizations**
- **Lightweight serializers** for list views
- **Atomic bulk operations** reduce round trips
- **Selective field loading** in querysets

---

## üîÑ **DATA FLOW EXAMPLES**

### **User Accesses Their Workspaces:**
```
Request ‚Üí Middleware (sets user context) ‚Üí WorkspaceViewSet.get_queryset() 
‚Üí Filters by user membership ‚Üí Serializer (adds role context) ‚Üí Response
```

### **Admin Impersonates User:**
```
Request with user_id ‚Üí Middleware (validates admin) ‚Üí Sets target_user 
‚Üí All viewsets use target_user for data ‚Üí Response includes impersonation context
```

### **Currency Change Operation:**
```
PATCH /workspace-settings/ ‚Üí CurrencyService.change_workspace_currency() 
‚Üí Update settings ‚Üí TransactionService.recalculate_all_transactions_for_workspace()
‚Üí Either ALL succeeds or ALL rolls back
```

---

## üéØ **KEY BUSINESS RULES**

1. **One user can own multiple workspaces**, but each workspace has one owner
2. **Transactions must have exactly one category** matching their type
3. **Currency conversions use historical rates** from transaction date
4. **Admin impersonation respects workspace boundaries**
5. **Category hierarchies support both flat and tree structures**
6. **All bulk operations are atomic** - success or complete rollback
7. **Workspace deletion requires confirmation** and has safety checks

Tento syst√©m poskytuje robustn√Ω, bezpeƒçn√Ω a v√Ωkonn√Ω finanƒçn√Ω mana≈æment pre enterprise prostredie s pokroƒçil√Ωmi admin funkciami a multi-currency podporou.